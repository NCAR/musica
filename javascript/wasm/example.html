<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUSICA WASM Example</title>
    <style>
        :root {
            --max-width: 1100px
        }

        body {
            font-family: Arial, sans-serif;
            max-width: var(--max-width);
            margin: 30px auto;
            padding: 20px;
            color: #222;
        }

        header.site-header {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 18px
        }

        header h1 {
            font-size: 28px;
            margin: 0
        }

        header .subheads {
            display: flex;
            gap: 12px;
            align-items: center
        }

        header .subheads .ver {
            font-size: 12px;
            color: #666
        }

        .layout {
            display: flex;
            gap: 18px
        }

        .left {
            flex: 0 0 360px
        }

        .right {
            flex: 1;
            min-width: 300px
        }

        .panel {
            background: #f7f9fb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px
        }

        .panel h3 {
            margin: 0 0 8px 0;
            font-size: 14px
        }

        .loading {
            color: #666
        }

        .version {
            font-weight: 600;
            color: #0a66c2
        }

        .error {
            color: #dc3545;
            background: #fff0f0;
            padding: 10px;
            border-radius: 6px
        }

        label.select-label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0
        }

        .slider-row label {
            width: 60px;
            font-size: 13px
        }

        .slider-row input[type=range] {
            flex: 1
        }

        .slider-row .val {
            width: 56px;
            text-align: right;
            font-weight: 600
        }

        table.results {
            width: 100%;
            border-collapse: collapse
        }

        table.results th,
        table.results td {
            border: 1px solid #e6e6e6;
            padding: 6px;
            text-align: left
        }

        @media (max-width:900px) {
            .layout {
                flex-direction: column
            }

            .left {
                flex-basis: auto
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
</head>

<body>
    <header class="site-header">
        <h1>MUSICA WASM</h1>
        <div class="subheads">
            <div class="ver">MUSICA Version: <span id="musica-version" class="version">—</span></div>
            <div class="ver">MICM Version: <span id="micm-version" class="version">—</span></div>
        </div>
    </header>

    <div id="content">
        <p class="loading">Initializing MUSICA WASM module...</p>

        <div class="layout" id="app-layout" style="display:none">
            <div class="left">
                <div class="panel" id="example-panel">
                    <h3>Example</h3>
                    <label class="select-label">Choose an example</label>
                    <select id="example-select"></select>
                    <p id="example-desc" style="font-size:13px;color:#444;margin-top:8px"></p>
                </div>

                <div class="panel" id="controls-panel">
                    <h3>Initial Conditions</h3>
                    <div id="sliders-container"></div>
                    <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
                        <label><input id="update-during-drag" type="checkbox" checked> Update while dragging</label>
                        <label><input id="toggle-table" type="checkbox"> Show results table</label>
                    </div>
                </div>
            </div>

            <div class="right">
                <div class="panel" id="plots-panel">
                    <h3>Plots</h3>
                    <div id="plot-area">
                        <div id="lorenz-plot" style="width:100%;height:420px"></div>
                    </div>
                </div>

                <div class="panel" id="results-panel" style="display:none">
                    <h3>Simulation Results</h3>
                    <div style="overflow:auto;max-height:260px">
                        <table id="results-table" class="results">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>X</th>
                                    <th>Y</th>
                                    <th>Z</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as musica from '../index.js';

        // Initialize and use the MUSICA package (uses WASM backend internally)
        async function initMUSICA() {
            const contentDiv = document.getElementById('content');

            try {
                await musica.initModule();

                // Get versions
                const musicaVersion = await musica.getVersion();
                const micmVersion = await musica.getMicmVersion();

                // Set header versions and reveal the UI
                document.getElementById('musica-version').textContent = musicaVersion;
                document.getElementById('micm-version').textContent = micmVersion;
                // hide the loading text and show the app layout
                const loader = contentDiv.querySelector('.loading'); if (loader) loader.style.display = 'none';
                document.getElementById('app-layout').style.display = '';

                // Run a short in-browser simulation test similar to the unit test
                try {
                    // Build a simple mechanism and prepare for interactive simulation
                    const { MICM } = musica;
                    const { types, reactionTypes, Mechanism } = musica.mechanismConfiguration;
                    const { Species, Phase, ReactionComponent } = types;

                    // Create species and phases (Lorenz attractor mapping)
                    const X = new Species({ name: 'X' });
                    const Y = new Species({ name: 'Y' });
                    const Z = new Species({ name: 'Z' });

                    const gas = new Phase({ name: 'gas', species: [X, Y, Z] });

                    // equations from this paper: https://link.springer.com/article/10.1007/s11071-025-11622-1 
                    const reactions = [
                        // α1 : X → ∅
                        new reactionTypes.UserDefined({
                            name: 'X_decay',
                            gas_phase: 'gas',
                            reactants: [new ReactionComponent({ species_name: 'X' })],
                            products: []
                        }),

                        // α2 : Y → X + Y
                        new reactionTypes.UserDefined({
                            name: 'Y_to_XY',
                            gas_phase: 'gas',
                            reactants: [new ReactionComponent({ species_name: 'Y' })],
                            products: [
                                new ReactionComponent({ species_name: 'X' }),
                                new ReactionComponent({ species_name: 'Y' })
                            ]
                        }),

                        // α3 : ∅ → Y
                        new reactionTypes.UserDefined({
                            name: 'Y_source',
                            gas_phase: 'gas',
                            reactants: [],
                            products: [new ReactionComponent({ species_name: 'Y' })]
                        }),

                        // α4 : Y → ∅
                        new reactionTypes.UserDefined({
                            name: 'Y_sink',
                            gas_phase: 'gas',
                            reactants: [new ReactionComponent({ species_name: 'Y' })],
                            products: []
                        }),

                        // α5 : X + Y → X + 2Y
                        new reactionTypes.UserDefined({
                            name: 'XY_to_X2Y',
                            gas_phase: 'gas',
                            reactants: [
                                new ReactionComponent({ species_name: 'X' }),
                                new ReactionComponent({ species_name: 'Y' })
                            ],
                            products: [
                                new ReactionComponent({ species_name: 'X' }),
                                new ReactionComponent({ species_name: 'Y' }),
                                new ReactionComponent({ species_name: 'Y' })
                            ]
                        }),

                        // α6 : Y + Z → 2Y
                        new reactionTypes.UserDefined({
                            name: 'YZ_to_2Y',
                            gas_phase: 'gas',
                            reactants: [
                                new ReactionComponent({ species_name: 'Y' }),
                                new ReactionComponent({ species_name: 'Z' })
                            ],
                            products: [
                                new ReactionComponent({ species_name: 'Y' }),
                                new ReactionComponent({ species_name: 'Y' })
                            ]
                        }),

                        // α7 : X + Y + Z → X + 2Z
                        new reactionTypes.UserDefined({
                            name: 'XYZ_to_X2Z',
                            gas_phase: 'gas',
                            reactants: [
                                new ReactionComponent({ species_name: 'X' }),
                                new ReactionComponent({ species_name: 'Y' }),
                                new ReactionComponent({ species_name: 'Z' })
                            ],
                            products: [
                                new ReactionComponent({ species_name: 'X' }),
                                new ReactionComponent({ species_name: 'Z' }),
                                new ReactionComponent({ species_name: 'Z' })
                            ]
                        }),

                        // α8 : ∅ → Z
                        new reactionTypes.UserDefined({
                            name: 'Z_source',
                            gas_phase: 'gas',
                            reactants: [],
                            products: [new ReactionComponent({ species_name: 'Z' })]
                        }),

                        // α9 : Z → 2Z
                        new reactionTypes.UserDefined({
                            name: 'Z_autocatalytic',
                            gas_phase: 'gas',
                            reactants: [new ReactionComponent({ species_name: 'Z' })],
                            products: [
                                new ReactionComponent({ species_name: 'Z' }),
                                new ReactionComponent({ species_name: 'Z' })
                            ]
                        }),

                        // α10 : X + Z → X
                        new reactionTypes.UserDefined({
                            name: 'XZ_quench',
                            gas_phase: 'gas',
                            reactants: [
                                new ReactionComponent({ species_name: 'X' }),
                                new ReactionComponent({ species_name: 'Z' })
                            ],
                            products: [new ReactionComponent({ species_name: 'X' })]
                        })

                    ];

                    const mechanism = new Mechanism({
                        name: 'Lorenz Polynomial CRN',
                        version: '1.0.0',
                        species: [X, Y, Z],
                        phases: [gas],
                        reactions
                    });

                    const micm = MICM.fromMechanism(mechanism);
                    const state = micm.createState(1);

                    // Set conditions and rate parameters once
                    state.setConditions({ temperatures: [298.15], pressures: [101325.0], air_densities: [1.0] });

                    let mu = 1.0 / 100;

                    state.setUserDefinedRateParameters({
                        'USER.X_decay': 10,
                        'USER.Y_to_XY': 10,
                        'USER.Y_source': 1 / mu,
                        'USER.Y_sink': 1 / mu + 29,
                        'USER.XY_to_X2Y': 1 + mu * 28,
                        'USER.YZ_to_2Y': 1,
                        'USER.XYZ_to_X2Z': mu,
                        'USER.Z_source': 8 / (3 * mu),
                        'USER.Z_autocatalytic': 1 / mu - 8 / 3,
                        'USER.XZ_quench': 1
                    });


                    // Data-driven examples (user may provide more later)
                    const examples = [
                        {
                            id: 'lorenz',
                            name: 'Lorenz Polynomial CRN',
                            description: 'Lorenz-like polynomial chemical reaction network (demo).',
                            initials: [
                                { species: 'X', min: -30, max: 30, step: 0.01, value: 1.0 },
                                { species: 'Y', min: -30, max: 30, step: 0.01, value: 28.0 },
                                { species: 'Z', min: -10, max: 50, step: 0.01, value: 1.0 }
                            ]
                        },
                        { id: 'example2', name: 'Example 2 (placeholder)', description: 'Placeholder — add example configuration later.', initials: [] },
                        { id: 'example3', name: 'Example 3 (placeholder)', description: 'Placeholder — add example configuration later.', initials: [] }
                    ];

                    // Populate example selector
                    const select = document.getElementById('example-select');
                    examples.forEach(ex => {
                        const opt = document.createElement('option');
                        opt.value = ex.id;
                        opt.textContent = ex.name;
                        select.appendChild(opt);
                    });

                    const exampleDesc = document.getElementById('example-desc');
                    const slidersContainer = document.getElementById('sliders-container');
                    const resultsPanel = document.getElementById('results-panel');
                    const resultsTbody = document.querySelector('#results-table tbody');

                    function clearSliders() { slidersContainer.innerHTML = ''; }

                    function createSliderRow(spec, min, max, step, initial) {
                        const row = document.createElement('div');
                        row.className = 'slider-row';
                        const label = document.createElement('label');
                        label.textContent = spec;
                        const input = document.createElement('input');
                        input.type = 'range';
                        input.min = String(min);
                        input.max = String(max);
                        input.step = String(step);
                        input.value = String(initial);
                        const val = document.createElement('div');
                        val.className = 'val';
                        val.textContent = String(initial);
                        input.addEventListener('input', () => { val.textContent = input.value; if (typeof updateWhileDragging !== 'undefined' && updateWhileDragging) runSimulation(); else runSimulationDebounced(); });
                        row.appendChild(label);
                        row.appendChild(input);
                        row.appendChild(val);
                        return { row, input };
                    }

                    let currentSliders = [];

                    // Option to update while dragging vs after drag stops
                    let updateWhileDragging = true;
                    const updateCheckbox = document.getElementById('update-during-drag');
                    if (updateCheckbox) {
                        updateWhileDragging = updateCheckbox.checked;
                        updateCheckbox.addEventListener('change', () => { updateWhileDragging = updateCheckbox.checked; });
                    }

                    function loadExampleById(id) {
                        const ex = examples.find(e => e.id === id);
                        if (!ex) return;
                        exampleDesc.textContent = ex.description || '';
                        clearSliders();
                        currentSliders = [];
                        if (!ex.initials || ex.initials.length === 0) {
                            const p = document.createElement('p');
                            p.style.fontSize = '13px';
                            p.style.color = '#666';
                            p.textContent = 'No initial condition sliders defined for this example.';
                            slidersContainer.appendChild(p);
                            return;
                        }
                        ex.initials.forEach(cfg => {
                            const s = createSliderRow(cfg.species, cfg.min, cfg.max, cfg.step, cfg.value);
                            slidersContainer.appendChild(s.row);
                            currentSliders.push({ species: cfg.species, input: s.input });
                        });
                    }

                    select.addEventListener('change', () => { loadExampleById(select.value); });

                    // Load default example
                    select.value = 'lorenz';
                    loadExampleById('lorenz');

                    // Debounced runner to avoid excessive simulations while dragging
                    let runTimer = null;
                    function runSimulationDebounced() {
                        if (runTimer) clearTimeout(runTimer);
                        runTimer = setTimeout(() => { runSimulation(); runTimer = null; }, 250);
                    }

                    // Function to read slider values from data-driven sliders
                    function readSliderValues() {
                        const out = {};
                        currentSliders.forEach(s => { out[s.species] = parseFloat(s.input.value); });
                        return out;
                    }

                    // Plotly plot updater: draws Lorenz attractor as a 3D trajectory
                    function updatePlot(times, Xseries, Yseries, Zseries) {
                        const plotDiv = document.getElementById('lorenz-plot');
                        if (!plotDiv) return;

                        const traj = {
                            x: Xseries,
                            y: Yseries,
                            z: Zseries,
                            mode: 'lines',
                            type: 'scatter3d',
                            line: { width: 2, color: '#1f77b4' },
                            name: 'trajectory'
                        };

                        const lastIdx = Xseries.length - 1;
                        const current = {
                            x: [Xseries[lastIdx]],
                            y: [Yseries[lastIdx]],
                            z: [Zseries[lastIdx]],
                            mode: 'markers',
                            type: 'scatter3d',
                            marker: { size: 4, color: '#d62728' },
                            name: 'current'
                        };

                        const layout = {
                            margin: { l: 0, r: 0, b: 0, t: 0 },
                            scene: {
                                xaxis: { title: 'X' },
                                yaxis: { title: 'Y' },
                                zaxis: { title: 'Z' },
                                camera: {
                                    eye: { x: 1, y: -2, z: 1 },
                                },
                            },
                            autosize: true,
                            height: 420
                        };

                        Plotly.newPlot(plotDiv, [traj, current], layout, { responsive: true });
                    }

                    // Run the simulation and populate the results table + plot
                    function runSimulation(steps = 2000, timeStep = 0.01, burnout = 100) {
                        // Reset table
                        resultsTbody.innerHTML = '';

                        // Reset concentrations from sliders
                        const vals = readSliderValues();
                        const conc = {};
                        if ('X' in vals) conc.X = [vals.X];
                        if ('Y' in vals) conc.Y = [vals.Y];
                        if ('Z' in vals) conc.Z = [vals.Z];
                        state.setConcentrations(conc);

                        let cumulativeTime = 0.0;

                        const times = [];
                        const Xs = [];
                        const Ys = [];
                        const Zs = [];

                        for (let i = 0; i < steps; i++) {
                            micm.solve(state, timeStep);
                            cumulativeTime += timeStep;

                            const concentrations = state.getConcentrations();
                            function val(spec) {
                                const v = concentrations[spec];
                                if (Array.isArray(v)) return v[0];
                                return v;
                            }

                            const xVal = val('X');
                            const yVal = val('Y');
                            const zVal = val('Z');

                            if (i < burnout) continue; // skip initial transient
                            times.push(cumulativeTime);
                            Xs.push(xVal);
                            Ys.push(yVal);
                            Zs.push(zVal);

                            const row = document.createElement('tr');
                            [cumulativeTime.toFixed(2), xVal, yVal, zVal].forEach(cellVal => {
                                const td = document.createElement('td');
                                td.textContent = String(cellVal);
                                row.appendChild(td);
                            });
                            resultsTbody.appendChild(row);
                        }

                        updatePlot(times, Xs, Ys, Zs);
                    }

                    // Initial run
                    runSimulation();
                } catch (err) {
                    const errDiv = document.createElement('div');
                    errDiv.className = 'error';
                    errDiv.innerHTML = `<h2>❌ Simulation Error</h2><p>${err.message}</p>`;
                    contentDiv.appendChild(errDiv);
                    console.error(err);
                }
            } catch (error) {
                contentDiv.innerHTML = `
                    <div class="error">
                        <h2>❌ Error Loading MUSICA WASM</h2>
                        <p>${error.message}</p>
                        <p>Make sure you've built the WASM module and are serving this page over HTTP (not file://).</p>
                    </div>
                `;
                console.error('Error:', error);
            }
        }

        // Start initialization when page loads
        initMUSICA();
    </script>
</body>

</html>