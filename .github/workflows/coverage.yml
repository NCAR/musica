name: Code Coverage

on: 
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  cpp-fortran-coverage:
    name: C++/Fortran Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Build Docker image
        run: docker build -t musica -f docker/Dockerfile.coverage . --build-arg MUSICA_GIT_TAG=${{ github.sha }} --build-arg BUILD_TYPE=Release

      - name: Run coverage tests in container
        run: docker run --name test-container -t musica bash -c 'make coverage ARGS="--rerun-failed --output-on-failure -j8"'

      - name: Copy coverage from container
        run: docker cp test-container:build/coverage.info .

      - name: Upload C++/Fortran coverage report
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.info
          flags: cpp_fortran
          name: cpp-fortran-coverage

  javascript-coverage:
    name: JavaScript Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Use Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 'v20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload JavaScript coverage report
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: javascript-coverage/lcov.info
          flags: javascript
          name: javascript-coverage

  python-coverage:
    name: Python Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y libnetcdf-dev netcdf-bin libnetcdff-dev liblapack-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Add python build tools
        run: python -m pip install --upgrade wheel setuptools build scikit-build-core

      - name: Build wheel
        run: |
          python -m build --wheel --no-isolation --outdir wheelhouse

      - name: Install wheel with test dependencies
        run: |
          whl=$(ls wheelhouse/*.whl | head -1)
          pip install "${whl}[test]"

      - name: Run tests with coverage
        run: pytest -s --cov=musica --cov-report=xml:python-coverage.xml --cov-report=term

      - name: Upload Python coverage report
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: python-coverage.xml
          flags: python
          name: python-coverage
