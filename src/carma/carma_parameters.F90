! Copyright (C) 2023-2025 National Center for Atmospheric Research
! SPDX-License-Identifier: Apache-2.0
!
! This module defines the CARMA parameters type that corresponds to the C++ CARMAParameters struct
module carma_parameters_mod

   use iso_fortran_env, only: real64
   use iso_c_binding, only: c_int, c_double, c_ptr, c_bool, c_char

   implicit none

   private

   public :: carma_group_config_t, carma_element_config_t, carma_parameters_t, &
             carma_wavelength_bin_t, carma_complex_t

   type, bind(c) :: carma_wavelength_bin_t
      real(c_double) :: center       ! Center of the wavelength bin [m]
      real(c_double) :: width        ! Width of the wavelength bin [m]
      logical(c_bool) :: do_emission ! Flag to indicate if emission is considered for this bin
   end type carma_wavelength_bin_t

   ! Complex number type for CARMA
   type, bind(c) :: carma_complex_t
      real(c_double) :: real_part    ! Real part of the complex number
      real(c_double) :: imag_part    ! Imaginary part of the complex number
   end type carma_complex_t

   type, bind(c) :: carma_group_config_t
      integer(c_int) :: name_length
      character(len=1, kind=c_char) :: name(256)
      integer(c_int) :: shortname_length
      character(len=1, kind=c_char) :: shortname(7)
      real(c_double) :: rmin
      real(c_double) :: rmrat
      real(c_double) :: rmassmin
      integer(c_int) :: ishape
      real(c_double) :: eshape
      integer(c_int) :: swelling_algorithm
      integer(c_int) :: swelling_composition
      integer(c_int) :: fall_velocity_routine
      integer(c_int) :: mie_calculation_algorithm
      integer(c_int) :: optics_algorithm
      logical(c_bool) :: is_ice
      logical(c_bool) :: is_fractal
      logical(c_bool) :: is_cloud
      logical(c_bool) :: is_sulfate
      logical(c_bool) :: do_wetdep
      logical(c_bool) :: do_drydep
      logical(c_bool) :: do_vtran
      real(c_double) :: solfac
      real(c_double) :: scavcoef
      real(c_double) :: dpc_threshold
      real(c_double) :: rmon
      type(c_ptr) :: df
      integer(c_int) :: df_size
      real(c_double) :: falpha
      real(c_double) :: neutral_volfrc
   end type carma_group_config_t

   type, bind(c) :: carma_element_config_t
      integer(c_int) :: igroup
      integer(c_int) :: isolute
      integer(c_int) :: name_length
      character(len=1, kind=c_char) :: name(256)
      integer(c_int) :: shortname_length
      character(len=1, kind=c_char) :: shortname(7)
      integer(c_int) :: itype
      integer(c_int) :: icomposition
      logical(c_bool) :: isShell
      real(c_double) :: rho
      type(c_ptr) :: rhobin
      integer(c_int) :: rhobin_size
      type(c_ptr) :: arat
      integer(c_int) :: arat_size
      real(c_double) :: kappa
      type(c_ptr) :: refidx  ! Complex refractive index
      integer(c_int) :: refidx_dim_1_size
      integer(c_int) :: refidx_dim_2_size
   end type carma_element_config_t

   type, bind(c) :: carma_parameters_t

      ! Model dimensions
      integer(c_int) :: nz = 1
      integer(c_int) :: ny = 1
      integer(c_int) :: nx = 1
      integer(c_int) :: nbin = 5
      integer(c_int) :: nsolute = 0
      integer(c_int) :: ngas = 0

      ! Time stepping parameters
      real(c_double) :: dtime = 1800.0_real64
      integer(c_int) :: nstep = 100

      ! Spatial parameters
      real(c_double) :: deltaz = 1000.0_real64
      real(c_double) :: zmin = 16500.0_real64

      ! Wavelength grid
      type(c_ptr) :: wavelength_bins  ! wavelength_bins(NWAVE)
      integer(c_int) :: wavelength_bin_size = 0
      integer(c_int) :: number_of_refractive_indices = 0  ! Number of refractive indices per wavelength

      ! Group and element configurations (will be handled through C interface)
      ! Note: groups and elements are managed through C pointers in interface
      type(c_ptr) :: groups
      integer(c_int) :: groups_size
      type(c_ptr) :: elements
      integer(c_int) :: elements_size
   end type carma_parameters_t

end module carma_parameters_mod
